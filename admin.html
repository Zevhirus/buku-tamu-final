<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Buku Tamu — (With Search, Filter, SweetAlert, Export, Pagination)</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- SheetJS (xlsx) for Excel export -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<!-- jsPDF + autotable for PDF export -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.25/dist/jspdf.plugin.autotable.min.js"></script>
<style>
body{font-family:'Poppins',sans-serif;background:#f4f7fb;padding:18px}
.card{background:white;border-radius:12px;padding:16px;box-shadow:0 6px 18px rgba(20,20,40,0.06);max-width:1200px;margin:8px auto}
.topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
.controls{display:flex;gap:8px;align-items:center}
input[type=text],select{padding:8px 10px;border-radius:8px;border:1px solid #e6edf3}
.btn{padding:8px 10px;border-radius:8px;border:none;cursor:pointer}
.btn-del{background:#ff4d4f;color:white}
.btn-export{background:#0a1f44;color:white}
.table-wrap{overflow:auto;max-height:58vh;margin-top:12px}
table{width:100%;border-collapse:collapse}
th,td{padding:10px 8px;text-align:left;border-bottom:1px solid #eef2f7;font-size:14px}
th{background:#fbfcfe;font-weight:700}
.small{font-size:12px;color:#6b7280}
.pagination{display:flex;gap:6px;align-items:center;margin-top:10px}
.page-btn{padding:6px 10px;border-radius:6px;border:1px solid #e6edf3;background:white;cursor:pointer}
.page-btn.active{background:#1b3b73;color:white;border-color:#1b3b73}
.page-size{padding:6px;border-radius:6px;border:1px solid #e6edf3}
</style>
</head>
<body>
<div class="card">
  <div class="topbar">
    <div>
      <h2>Admin — Data Buku Tamu</h2>
      <div class="small">Realtime dari Firebase. Delete menggunakan SweetAlert konfirmasi.</div>
    </div>

    <div class="controls">
      <input id="searchInput" type="text" placeholder="Cari nama, instansi, nohp, keperluan...">
      <select id="filterTujuan">
        <option value="">Filter: Semua Tujuan</option>
        <option>SUBAG KESEKRETARIATAN</option>
        <option>SUBAG PROGRAM</option>
        <option>SUBAG UMUM</option>
        <option>SUBAG KEUANGAN</option>
        <option>BIDANG PENGEMBANGAN</option>
        <option>KEPALA DINAS</option>
      </select>
      <select id="pageSize" class="page-size">
        <option value="5">5 / halaman</option>
        <option value="10" selected>10 / halaman</option>
        <option value="25">25 / halaman</option>
        <option value="50">50 / halaman</option>
      </select>
      <button id="exportExcel" class="btn btn-export">Export Excel</button>
      <button id="exportPDF" class="btn btn-export">Export PDF</button>
      <button id="refreshBtn" class="btn">Refresh</button>
      <button id="backBtn" class="btn">Kembali</button>
    </div>
  </div>

  <div class="table-wrap">
    <table id="tamuTable">
      <thead>
        <tr>
          <th>#</th>
          <th>Nama</th>
          <th>Instansi</th>
          <th>Tujuan</th>
          <th>Jumlah</th>
          <th>No HP</th>
          <th>Keperluan</th>
          <th>Waktu</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="pagination" id="pagination"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getDatabase, ref, onValue, remove } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

// Firebase config (sama seperti index)
const firebaseConfig = {
  apiKey: "AIzaSyBrXHQINUTCoAB3m2iVJQikkP6Q9850z94",
  authDomain: "uku-a2eb8.firebaseapp.com",
  databaseURL: "https://uku-a2eb8-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "uku-a2eb8",
  storageBucket: "uku-a2eb8.firebasedatabase.app",
  messagingSenderId: "1069686721096",
  appId: "1:1069686721096:web:1cb3cef4f6e112453d667d"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const tableBody = document.querySelector('#tamuTable tbody');
const searchInput = document.getElementById('searchInput');
const filterTujuan = document.getElementById('filterTujuan');
const refreshBtn = document.getElementById('refreshBtn');
const exportExcelBtn = document.getElementById('exportExcel');
const exportPDFBtn = document.getElementById('exportPDF');
const backBtn = document.getElementById('backBtn');
const paginationEl = document.getElementById('pagination');
const pageSizeSel = document.getElementById('pageSize');

let rawData = []; // array of {key, ...data}
let filtered = [];
let currentPage = 1;
let pageSize = parseInt(pageSizeSel.value,10);

function mapSnapshotToArray(val){
  if(!val) return [];
  return Object.keys(val).map(k => ({ key: k, ...val[k] }));
}

function applyFilters(){
  const q = searchInput.value.trim().toLowerCase();
  const tujuan = filterTujuan.value;

  filtered = rawData.filter(item => {
    if(tujuan && item.tujuan !== tujuan) return false;
    if(!q) return true;
    // search in several fields
    return (item.nama||'').toLowerCase().includes(q) ||
           (item.instansi||'').toLowerCase().includes(q) ||
           (item.nohp||'').toLowerCase().includes(q) ||
           (item.keperluan||'').toLowerCase().includes(q) ||
           (item.tujuan||'').toLowerCase().includes(q);
  });
  currentPage = 1; // reset page
  renderTable();
}

function renderTable(){
  tableBody.innerHTML = '';
  if(filtered.length === 0){
    tableBody.innerHTML = '<tr><td colspan="9">Belum ada data yang cocok.</td></tr>';
    paginationEl.innerHTML = '';
    return;
  }

  pageSize = parseInt(pageSizeSel.value,10);
  const totalPages = Math.ceil(filtered.length / pageSize);
  if(currentPage > totalPages) currentPage = totalPages;
  const start = (currentPage-1)*pageSize;
  const pageItems = filtered.slice(start, start + pageSize);

  pageItems.forEach((item, idx) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${start + idx + 1}</td>
      <td>${item.nama || ''}</td>
      <td>${item.instansi || ''}</td>
      <td>${item.tujuan || ''}</td>
      <td>${item.jumlah_tamu || ''}</td>
      <td>${item.nohp || ''}</td>
      <td>${item.keperluan || ''}</td>
      <td>${item.waktukunjungan || ''}</td>
      <td><button class="btn btn-del" data-key="${item.key}">Hapus</button></td>
    `;
    tableBody.appendChild(tr);
  });

  // attach delete handlers
  document.querySelectorAll('.btn-del').forEach(btn => {
    btn.addEventListener('click', () => handleDelete(btn.getAttribute('data-key')));
  });

  // render pagination
  renderPagination(totalPages);
}

function renderPagination(totalPages){
  paginationEl.innerHTML = '';
  if(totalPages <= 1) return;

  // prev
  const prev = document.createElement('button'); prev.className='page-btn'; prev.textContent='Prev';
  prev.disabled = currentPage === 1; prev.addEventListener('click', ()=>{ if(currentPage>1){currentPage--; renderTable();} });
  paginationEl.appendChild(prev);

  // pages (show up to 7 pages with ellipsis)
  const maxShown = 7; let start = Math.max(1, currentPage - 3); let end = Math.min(totalPages, start + maxShown - 1);
  if(end - start < maxShown -1) start = Math.max(1, end - maxShown + 1);
  for(let p = start; p <= end; p++){
    const b = document.createElement('button'); b.className='page-btn'+(p===currentPage?' active':''); b.textContent=p;
    b.addEventListener('click', ()=>{ currentPage = p; renderTable(); });
    paginationEl.appendChild(b);
  }

  // next
  const next = document.createElement('button'); next.className='page-btn'; next.textContent='Next';
  next.disabled = currentPage === totalPages; next.addEventListener('click', ()=>{ if(currentPage<totalPages){currentPage++; renderTable();} });
  paginationEl.appendChild(next);
}

async function handleDelete(key){
  const result = await Swal.fire({
    title: 'Hapus entri?',
    text: 'Tindakan ini tidak dapat dibatalkan.',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'Ya, hapus',
    cancelButtonText: 'Batal',
    confirmButtonColor: '#d33'
  });

  if(result.isConfirmed){
    try{
      await remove(ref(db, 'bukutamu/' + key));
      Swal.fire('Terhapus!', 'Entri berhasil dihapus.', 'success');
    }catch(err){
      Swal.fire('Gagal', err.message, 'error');
    }
  }
}

function loadDataRealtime(){
  const bukutamuRef = ref(db, 'bukutamu');
  onValue(bukutamuRef, (snapshot) => {
    const val = snapshot.val();
    rawData = mapSnapshotToArray(val).reverse(); // latest first
    // apply currently selected filter/search
    applyFilters();
  });
}

// Export Excel
exportExcelBtn.addEventListener('click', ()=>{
  if(filtered.length === 0){ Swal.fire('Kosong','Tidak ada data untuk diexport','info'); return; }
  const dataForExport = filtered.map((row, idx) => ({
    No: idx+1,
    Nama: row.nama || '',
    Instansi: row.instansi || '',
    Tujuan: row.tujuan || '',
    Jumlah: row.jumlah_tamu || '',
    NoHP: row.nohp || '',
    Keperluan: row.keperluan || '',
    Waktu: row.waktukunjungan || ''
  }));
  const ws = XLSX.utils.json_to_sheet(dataForExport);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'BukuTamu');
  XLSX.writeFile(wb, 'bukutamu_export.xlsx');
});

// Export PDF
exportPDFBtn.addEventListener('click', ()=>{
  if(filtered.length === 0){ Swal.fire('Kosong','Tidak ada data untuk diexport','info'); return; }
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('l','pt','a4');
  const head = [['No','Nama','Instansi','Tujuan','Jumlah','No HP','Keperluan','Waktu']];
  const body = filtered.map((r, idx) => [idx+1, r.nama||'', r.instansi||'', r.tujuan||'', r.jumlah_tamu||'', r.nohp||'', r.keperluan||'', r.waktukunjungan||'']);
  doc.text('Data Buku Tamu', 40, 40);
  doc.autoTable({ head, body, startY: 60, styles:{fontSize:8}, headStyles:{fillColor:[26,59,115]} });
  doc.save('bukutamu_export.pdf');
});

// events
searchInput.addEventListener('input', () => applyFilters());
filterTujuan.addEventListener('change', () => applyFilters());
pageSizeSel.addEventListener('change', () => { currentPage = 1; renderTable(); });
refreshBtn.addEventListener('click', () => { loadDataRealtime(); Swal.fire('Refreshed','Data direfresh','success'); });
backBtn.addEventListener('click', () => { window.location.href = '/mnt/data/index.html'; });

// initial
loadDataRealtime();
</script>
</body>

</html>
